liveChinaApp.controller("liveList",["$scope","$http","API_URL_ROOT","$routeParams","$location","$timeout","$interval","$window",function($scope,$http,API_URL_ROOT,$routeParams,$location,$timeout,$interval,$window){var docHeight=document.documentElement.clientHeight;var clientWidth=document.body.clientWidth;var videoheight=Math.ceil(clientWidth*0.75);var videoinfoheight=videoheight;$(".live-video-info").css("height",videoinfoheight);$(".live-video").css("height",videoheight);$scope.id=$routeParams.id;$scope.time_status=1;$scope.time_status=$routeParams.time_status;$scope.tag="interaction";$scope.offset=0;$scope.count=6;$scope.loading=false;$scope.commit="";$scope.scroll=true;$scope.showTotalMessage=false;$scope.touched=false;$scope.share_url="";$scope.color=true;$scope.loadCommit=true;$scope.IOSHide=false;$scope.changeIntroduce=function(status){$scope.tag=status;if(status==="introduce"){angular.element(document.querySelector("#underLine")).addClass("toLeft").removeClass("toRight").removeClass("underLine")}else{angular.element(document.querySelector("#underLine")).removeClass("toLeft").addClass("toRight").removeClass("underLine")}};$http({method:"JSONP",url:"http://operate.tw.live.hoge.cn"+"?callback=JSON_CALLBACK&m=Apituwenol&c=tuwenol&a=detail&custom_appkey=G8FHXedPgl4i7sA2rfUISxfaB0NB5WJC&custom_appid=83&id="+$scope.id}).success(function(res){$scope.share_url=res.share_url;$scope.videoUrl=res[0].live_info[0].url;window.sessionStorage.setItem("videoUrl",$scope.videoUrl);$scope.loading=false;$scope.dataList=res;$scope.sort_pic=$scope.dataList[0].sort_pic;$scope.sort_name=$scope.dataList[0].sort_name;console.log($scope.dataList[0]);$scope.timeLong=parseInt((res[0].end_time*1-res[0].start_time*1)/60/60%24)+"小时"+parseInt((res[0].end_time*1-res[0].start_time*1)/60%60)+"分"+parseInt((res[0].end_time*1-res[0].start_time*1)%60)+"秒";$scope.getComment()});$scope.totalMessage=function(){if($scope.time_status==1){var nowData=(new Date()).getTime();if(nowData>$scope.dataList[0].end_time*1000&&nowData<$scope.dataList[0].end_time*1000+3000){$scope.showTotalMessage=true}}};$scope.load=false;$scope.commitArr=[];$scope.cleartimer=true;var animateOnce=1;$scope.getComment=function(){animateOnce++;$scope.loading=true;$scope.commentNum=0;$http({method:"JSONP",url:API_URL_ROOT+"?m=Apituwenol&c=thread&a=show_comment&callback=JSON_CALLBACK"+"&custom_appkey=G8FHXedPgl4i7sA2rfUISxfaB0NB5WJC&custom_appid=83&order=desc&count=6&offset=0&topic_id="+$scope.id}).success(function(comment){$scope.loading=false;if(comment.length>0){comment.filter(function(item,index,arr){if(item.user_name.length>4){item.user_name=item.user_name.slice(0,2)+"..."+item.user_name.slice(item.user_name.length-2)}})}if($scope.commitArr.length==0){$scope.commitArr=comment.reverse()}else{if($scope.commitArr.length>0&&comment.length>0){const yid=[];const xid=[];for(var j=0;j<comment.length;j++){yid.push(comment[j].id)}for(var i=0;i<$scope.commitArr.length;i++){xid.push($scope.commitArr[i].id)}for(var i=0;i<comment.length;i++){if(xid.indexOf(yid[i])<0){$scope.commentNum++;$scope.commitArr.push(comment[i])}}setTimeout(watch,1)}}})};function watch(){var currentHeight=document.getElementById("interaction").clientHeight||0;var innerHeight=document.getElementById("listsbox").scrollHeight||0;$scope.moved=innerHeight-currentHeight+15;if(animateOnce==2){$("#interaction").animate({scrollTop:$scope.moved})}$("#interaction").animate({scrollTop:$scope.moved});$scope.$watch("moved",function(newValue,oldValue){if(newValue!=oldValue){$scope.scrollDiv()}})}$scope.scrollDiv=function(){if($location.$$absUrl.indexOf("liveList")>0&&$scope.loadcommit&&$scope.tag==="interaction"){$("#interaction").animate({scrollTop:$scope.moved})}};$scope.changeTime=function(t){var ua=navigator.userAgent.toLowerCase();if(/iphone|ipad|ipod/.test(ua)){t=t.replace(/-/g,"/")}var oldTime=(new Date(t).getTime());var newTime=new Date().getTime();var timeType=parseInt((newTime-oldTime)/1000/60);if((newTime-oldTime)/1000>0&&(newTime-oldTime)/1000<60){return"刚刚"}else{if(timeType>0&&timeType<60){return parseInt(timeType)+"分钟前"}else{if(timeType/60>0&&timeType/60<23){return parseInt(timeType/60)+"小时前"}else{return t.substr(0,10)}}}};$scope.see=function(){$scope.totalMessage();if($scope.tag=="interaction"&&$scope.time_status!=0&&$scope.loadCommit===true){$scope.getComment()}};var timer1=setInterval($scope.see,3000);$scope.sendMessage=function(e){if($scope.loadCommit==false){$scope.loadCommit=true}$scope.content=e.target.name;if($scope.content==""||$scope.content==undefined||$scope.content==null){return false}else{if(!$scope.scroll){$scope.scroll}e.target.innerHTML="发表";$http({method:"JSONP",url:API_URL_ROOT+"?&callback=JSON_CALLBACK&m=Apituwenol&c=interact&a=show&type=comment&custom_appkey=G8FHXedPgl4i7sA2rfUISxfaB0NB5WJC&custom_appid=83&content="+$scope.content+"&topic_id="+$scope.id}).success(function(comment){e.target.innerHTML="发表";angular.element(document.querySelector("#input")).val("");e.target.name=""})}};$scope.share=function(){SmartCity.shareTo({title:$scope.dataList[0].title,brief:$scope.dataList[0].brief,contentURL:$scope.share_url,imageLink:$scope.dataList[0].sort_pic})
};$scope.cancelModal=function(){$scope.showTotalMessage=false};$scope.goBack3=function(e){window.history.back();clearInterval(timer1)};$scope.startTimer=function(){$scope.cleartimer=true;var u=navigator.userAgent;var isIOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);console.dir(document.getElementById("interaction"));if(isIOS){$(document).on("focus","input",function(){$("#sendMsg").addClass("fixfixed")}).on("focusout","input",function(){$("#sendMsg").removeClass("fixfixed")})}};$scope.onTouchstart=function(ev){ev.stopPropagation();ev.preventDefault();window.event.cancelBubble=false;$scope.loadCommit=false;document.getElementById("input").blur();$scope.startY=ev.touches[0].clientY;if($("#listbox").scrollTop()==0){}};var scrollTop;$scope.touchend=function(e){e.stopPropagation();e.preventDefault();window.event.cancelBubble=false;$scope.endY=e.changedTouches[0].clientY;$scope.movelen=$scope.startY-$scope.endY;$scope.loading=true;if(Math.abs($scope.movelen)>10){$("#interaction").animate({scrollTop:$scope.movelen*15});if($scope.movelen>0){$timeout(function(){scrollTop=$("#interaction").scrollTop()},1);if($scope.movelen>scrollTop-30){$scope.loadCommit=true}}}$scope.cleartimer=false;if($scope.movelen<0&&$("#interaction").scrollTop()===0){$http({method:"JSONP",url:API_URL_ROOT+"?m=Apituwenol&c=thread&a=show_comment&callback=JSON_CALLBACK&"+"custom_appkey=G8FHXedPgl4i7sA2rfUISxfaB0NB5WJC&custom_appid=83&order=sc&offset="+$scope.commitArr.length+"&count="+$scope.count+"&topic_id="+$scope.id}).success(function(comment){Array.prototype.unshift.apply($scope.commitArr,comment);$scope.loading=false})}};$scope.cancelModal=function(){$scope.showTotalMessage=false}}]);liveChinaApp.filter("trustUrl",["$sce",function($sce){return function(recordingUrl){return $sce.trustAsResourceUrl(recordingUrl)}}]);